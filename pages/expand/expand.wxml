<view class="expand-container">
  <navigation-header id="navHeader"></navigation-header>
  <view class="tabs-placeholder" style="height: 110rpx; width: 100%;"></view>

  <!-- 顶部Tab栏 -->
  <view class="tabs-container" style="top: {{navHeaderHeightRpx}}rpx;">
    <view 
      class="tab-item {{currentTab === 'recommend' ? 'active' : ''}} one"
      bindtap="handleTabClick"
      data-tab="recommend"
    >推荐</view>
    <view 
      class="tab-item {{currentTab === 'potential' ? 'active' : ''}} two"
      bindtap="handleTabClick"
      data-tab="potential"
    >潜在人脉</view>
    <view 
      class="filter-btn"
      wx:if="{{currentTab === 'potential'}}"
      bindtap="handleFilterClick"  
    >
      <image src="../../assets/image/设置配置.png" class="filter-icon" mode="widthFix" style= "width: 100%; height: 100%;"></image>
    </view>
  </view>

  <!-- 内容滚动区域 - 【修改】添加scroll-view下拉刷新属性 -->
  <scroll-view 
    class="tab-content" 
    scroll-y="{{true}}"
    scroll-top="{{scrollTop[currentTab]}}"
    data-tab="{{currentTab}}"
    enhanced="{{true}}"  
    bounce="{{false}}"  
    scroll-with-animation="{{true}}"  
    show-scrollbar="{{false}}"
    bindscroll="handleScroll"
    refresher-enabled="{{currentTab === 'potential'}}"
    refresher-triggered="{{isRefreshingList}}"
    bindrefresherrefresh="handlePullToRefresh"
    refresher-background="#F8F9FD"
    style="height: calc(100vh - {{navHeaderHeightRpx}}rpx - 110rpx - env(safe-area-inset-bottom));"
  >
    <!-- 推荐Tab内容 -->
    <view class="content-recommend" wx:if="{{currentTab === 'recommend'}}">
      <view class="empty-state" wx:if="{{isNoNetwork}}">
        <text class="empty-text">无网络连接，请检查网络后重试</text>
      </view>
      <view class="search-container" bindtap="triggerSearch" wx:else>
        <image src="" class="btn-gif" mode="widthFix"></image>
        <text class="btn-text">正在为您搜寻潜在人脉</text>
      </view>
    </view>

    <!-- 潜在人脉Tab内容 -->
    <view class="content-potential" wx:else>
      <view class="empty-state" wx:if="{{isNoNetwork}}">
        <text class="empty-text">无网络连接，请检查网络后重试</text>
      </view>
      <view wx:else>
        <!-- 顶部推荐人卡片滑动区（无数据则隐藏） -->
        <view class="top-cards-container" wx:if="{{displayCandidates.length > 0}}">
          <scroll-view 
            class="cards-scroll"
            scroll-x="true"
            enable-flex="true"
            scroll-with-animation="true"
            enhanced="false"
            show-scrollbar="false"
            bindscroll="handleCardScroll"
            bindtouchstart="handleCardTouchStart"
            bindtouchmove="handleCardTouchMove"
          >
            <block wx:for="{{displayCandidates}}" wx:key="id">
              <view 
                class="card-item" 
                bindtap="handleCardClick"
                data-id="{{item.id}}"
              >
                <image class="card-avatar" src="{{item.avatar}}" mode="aspectFill"></image>
                <view class="card-info">
                  <text class="card-name">{{item.name}}</text>
                  <text class="card-summary">{{item.summary}}</text>                
                </view>
                <view 
                  class="card-close" 
                  catchtap="handleDismissCard" 
                  data-id="{{item.id}}"
                >×</view>
              </view>
            </block>
          </scroll-view>
        </view>

        <!-- 下方潜在人脉列表 -->
        <view class="potential-list" wx:if="{{potentialList.length > 0}}">
          <view 
            class="content-item" 
            wx:for="{{potentialList}}" 
            wx:key="id"
            bindtap="handlePotentialItemClick"
            data-item="{{item}}"
          >
            <view class="potential-item">
              <!-- 左侧头像 -->
              <view class="item-avatar">
                <image 
                  class="avatar-img" 
                  src="{{item.avatar || '/assets/images/default-avatar.png'}}" 
                  mode="aspectFill"
                />
              </view>
              
              <!-- 中间信息区域 -->
              <view class="item-info">
                <view class="info-main">
                  <text class="item-name">{{item.name || '未知用户'}}</text>
                  <text class="item-age" wx:if="{{item.age}}">{{item.age}}</text>
                </view>
                <view class="info-details">
                  <text class="connection-level">{{item.level || '2级人脉'}}</text>
                  <text class="mutual-count" wx:if="{{item.mutualCount > 0}}">{{item.mutualCount}}位共同人脉</text>
                  <text class="connection-desc">{{item.desc || '暂无关系描述'}}</text>
                </view>
              </view>
              
              <!-- 右侧组CP按钮 -->
              <view 
                class="cp-button {{item.cpEligible === false || item.cpStatus === 'pending' ? 'disabled' : ''}}"
                catchtap="handleCpButtonClick"
                data-item="{{item}}"
              >
                <text class="cp-button-text">{{item.cpStatus === 'pending' ? '邀请中' : '组CP'}}</text>
              </view>
            </view>
          </view>
          
          <!-- 【新增】分页加载状态 -->
          <view class="load-more-state">
            <text wx:if="{{isLoading && hasMore}}" class="loading-text">加载中...</text>
            <text wx:if="{{!hasMore && potentialList.length > 0}}" class="no-more-text">没有更多了</text>
          </view>
        </view>
        
        <!-- 加载失败状态 -->
        <view class="load-error-state" wx:if="{{loadError && potentialList.length === 0}}">
          <text class="error-text">加载失败，请重试</text>
          <view class="retry-button" bindtap="handleRetryLoad">
            <text class="retry-text">重新加载</text>
          </view>
        </view>
        
        <!-- 无数据状态 -->
        <view class="empty-state" wx:if="{{potentialList.length === 0 && !loadError}}">
          <text class="empty-text">暂无潜在人脉数据</text>
        </view>
      </view>
    </view>
  </scroll-view>
</view>