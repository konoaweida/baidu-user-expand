<view class="expand-container">
  <navigation-header id="navHeader"></navigation-header>
  <view class="tabs-placeholder" style="height: 110rpx; width: 100%;"></view>

  <view class="tabs-container" style="top: {{navHeaderHeightRpx}}rpx;">
    <view
      class="tab-item {{currentTab === 'recommend' ? 'active' : ''}} one"
      bindtap="handleTabClick"
      data-tab="recommend"
    >推荐</view>
    <view
      class="tab-item {{currentTab === 'potential' ? 'active' : ''}} two"
      bindtap="handleTabClick"
      data-tab="potential"
    >潜在人脉</view>
    <view
      class="filter-btn"
      wx:if="{{currentTab === 'potential'}}"
      bindtap="handleFilterClick"
    >
      <image src="../../assets/image/设置配置.png" class="filter-icon" mode="widthFix" style="width: 100%; height: 100%;"></image>
    </view>
  </view>

  <scroll-view
    class="tab-content"
    scroll-y="{{true}}"
    scroll-top="{{scrollTop[currentTab]}}"
    data-tab="{{currentTab}}"
    enhanced="{{true}}"
    bounce="{{false}}"
    scroll-with-animation="{{true}}"
    show-scrollbar="{{false}}"
    bindscroll="handleScroll"
    refresher-enabled="{{currentTab === 'potential'}}"
    refresher-triggered="{{isRefreshingList}}"
    bindrefresherrefresh="handlePullToRefresh"
    refresher-background="#F8F9FD"
    style="height: calc(100vh - {{navHeaderHeightRpx}}rpx - 110rpx - env(safe-area-inset-bottom));"
  >
    <!-- 推荐页内容 -->
    <view class="content-recommend" wx:if="{{currentTab === 'recommend'}}">
      <view class="empty-state" wx:if="{{isNoNetwork}}">
        <text class="empty-text">无网络连接，请检查网络后重试</text>
      </view>
      <view class="search-container" bindtap="triggerSearch" wx:else>
        <image src="" class="btn-gif" mode="widthFix"></image>
        <text class="btn-text">正在为您搜寻潜在人脉</text>
      </view>
    </view>

    <!-- 潜在人脉页内容 -->
    <view class="content-potential" wx:else>
      <view class="empty-state" wx:if="{{isNoNetwork}}">
        <text class="empty-text">无网络连接，请检查网络后重试</text>
      </view>
      <view wx:else>
        <!-- 顶部推荐人卡片区域 -->
        <view class="top-cards-container">
          <!-- 顶部推荐人骨架屏（自定义实现） -->
          <view wx:if="{{showSkeleton}}" class="cards-skeleton">
            <block wx:for="{{[1,2,3,4,5]}}" wx:key="index">
              <view class="skeleton-card">
                <view class="skeleton-avatar"></view>
                <view class="skeleton-name"></view>
                <view class="skeleton-summary"></view>
              </view>
            </block>
          </view>

          <!-- 顶部推荐人真实卡片 -->
          <scroll-view
            class="cards-scroll"
            scroll-x="true"
            enable-flex="true"
            scroll-with-animation="true"
            enhanced="false"
            show-scrollbar="false"
            bindscroll="handleCardScroll"
            bindtouchstart="handleCardTouchStart"
            bindtouchmove="handleCardTouchMove"
            wx:else
          >
            <block wx:for="{{displayCandidates}}" wx:key="id">
              <view
                class="card-item"
                bindtap="handleCardClick"
                data-id="{{item.id}}"
              >
                <image class="card-avatar" src="{{item.avatar}}" mode="aspectFill" lazy-load="true"></image>
                <view class="card-info">
                  <text class="card-name">{{item.name}}</text>
                  <text class="card-summary">{{item.summary}}</text>
                </view>
                <view
                  class="card-close"
                  catchtap="handleDismissCard"
                  data-id="{{item.id}}"
                >×</view>
              </view>
            </block>
          </scroll-view>
        </view>

        <!-- 潜在人脉列表骨架屏（自定义实现，替换原组件） -->
        <view class="potential-skeleton" wx:if="{{showSkeleton}}">
          <block wx:for="{{[1,2,3,4,5,6]}}" wx:key="index">
            <view class="skeleton-potential-group">
              <!-- 头像骨架 -->
              <view class="skeleton-potential-avatar"></view>
              <!-- 内容区骨架 -->
              <view class="skeleton-potential-content">
                <view class="skeleton-potential-name"></view>
                <view class="skeleton-potential-desc"></view>
              </view>
            </view>
          </block>
        </view>

        <!-- 潜在人脉真实列表 -->
        <view class="potential-list" wx:if="{{potentialList.length > 0 && !showSkeleton}}">
          <view class="virtual-scroll-container" style="height: {{virtualHeightRpx}}rpx; position: relative;">
            <view class="virtual-list" style="transform: translateY({{translateYRpx}}rpx);">
              <block wx:for="{{visibleList}}" wx:key="id">
                <view 
                  class="content-item virtual-item" 
                  style="height: {{itemHeightRpx}}rpx;"
                  bindtap="handlePotentialItemClick"
                  data-item="{{item}}"
                >
                  <view class="potential-item">
                    <view class="item-avatar">
                      <image
                        class="avatar-img"
                        src="{{item.avatar || '/assets/images/default-avatar.png'}}"
                        mode="aspectFill"
                        lazy-load="true"
                      />
                    </view>

                    <view class="item-info">
                      <view class="info-main">
                        <text class="item-name">{{item.name || '未知用户'}}</text>
                        <text class="item-age" wx:if="{{item.age}}">{{item.age}}</text>
                      </view>
                      <view class="info-details">
                        <text class="connection-level">{{item.level || '2级人脉'}}</text>
                        <text class="mutual-count" wx:if="{{item.mutualCount > 0}}">{{item.mutualCount}}位共同人脉</text>
                        <text class="connection-desc">{{item.desc || '暂无关系描述'}}</text>
                      </view>
                    </view>

                    <view
                      class="cp-button {{item.cpEligible === false || item.cpStatus === 'pending' ? 'disabled' : ''}}"
                      catchtap="handleCpButtonClick"
                      data-item="{{item}}"
                    >
                      <text class="cp-button-text">{{item.cpStatus === 'pending' ? '邀请中' : '组CP'}}</text>
                    </view>
                  </view>
                </view>
              </block>
            </view>
          </view>

          <view class="load-more-state">
            <text wx:if="{{isLoading && hasMore}}" class="loading-text">加载中...</text>
            <text wx:if="{{preloadingNextPage && !isLoading}}" class="loading-text">预加载中...</text>
            <text wx:if="{{!hasMore && potentialList.length > 0}}" class="no-more-text">没有更多了</text>
          </view>
        </view>

        <!-- 加载失败状态 -->
        <view class="load-error-state" wx:if="{{loadError && potentialList.length === 0 && !showSkeleton}}">
          <text class="error-text">加载失败，请重试</text>
          <view class="retry-button" bindtap="handleRetryLoad">
            <text class="retry-text">重新加载</text>
          </view>
        </view>

        <!-- 空状态 -->
        <view class="empty-state" wx:if="{{potentialList.length === 0 && !loadError && !isLoading && !showSkeleton}}">
          <text class="empty-text">暂无潜在人脉数据</text>
        </view>
      </view>
    </view>
  </scroll-view>
</view>