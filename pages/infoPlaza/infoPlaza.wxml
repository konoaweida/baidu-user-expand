<!-- 顶部导航栏 -->
<navigation-header id="navHeader" class="nav-header">
  <view class="search-row">
    <view class="search-box {{isFocus ? 'search-box-focus' : ''}}">
      <image class="search-icon" src="../../assets/image/路径 7.png" mode="aspectFit"></image>
      <input 
        class="search-input" 
        placeholder="圈外搜索" 
        placeholder-class="search-placeholder"
        bindinput="onSearchInput" 
        bindfocus="onFocus"   
        bindblur="onBlur"     
        value="{{inputValue}}"
      />
      <image 
        class="clear-icon" 
        src="../../assets/image/union.png"  
        mode="aspectFit"
        wx:if="{{isFocus && inputValue.length > 0}}"
        bindtap="clearInput"
      ></image>
    </view>
    <text class="cancel-btn" wx:if="{{isFocus}}" bindtap="onCancel">取消</text>
  </view>
</navigation-header>

<!-- tab栏 -->
<view class="tabs-placeholder" style="height: 110rpx; width: 100%;"></view>
<view class="tabs-container" style="top: {{navHeaderHeightRpx}}rpx;">
  <view
    class="tab-item {{currentTab === 'outCircle' ? 'active' : ''}}"
    bindtap="handleTabClick"
    data-tab="outCircle"
  >圈外</view>
  <view
    class="tab-item {{currentTab === 'inCircle' ? 'active' : ''}}"
    bindtap="handleTabClick"
    data-tab="inCircle"
  >圈内</view>
</view>

<!-- 动态列表容器（修复刷新状态绑定） -->
<scroll-view
  class="dynamic-list"
  scroll-y
  enhanced  
  show-scrollbar="{{false}}"  
  scroll-with-animation="{{false}}"  
  style="height: calc(100vh - {{navHeaderHeightRpx + 110}}rpx);"
  bindscroll="onListScroll"
  scroll-top="{{scrollTop[currentTab] || 0}}"
  refresher-enabled="{{true}}" 
  refresher-threshold="100"   
  refresher-default-style="black"  
  bindrefresherrefresh="onPullRefresh"  
  bindrefresherrestore="onRefresherRestore" 
  refresher-triggered="{{isRefreshing[currentTab]}}" 
>
  <!-- 首屏骨架屏 -->
  <view class="skeleton-list" wx:if="{{isSkeletonLoading[currentTab]}}">
    <view class="skeleton-item" wx:for="{{[1,2]}}" wx:key="index">
      <view class="skeleton-userinfo">
        <view class="skeleton-avatar"></view>
        <text class="skeleton-nickname"></text>
      </view>
      <view class="skeleton-desc"></view>
      <view class="skeleton-content"></view>
    </view>
  </view>

  <!-- 动态列表 -->
  <view class="dynamic-item-list" wx:else>
    <view wx:for="{{dynamicList[currentTab]}}" wx:key="id">
      <!-- 组件引用：确保组件已注册 -->
      <moment-list
        moment="{{item}}"
        show-cp-tag="{{currentTab === 'inCircle'}}"
        bind:like="handleMomentLike"
        bind:comment="handleMomentComment"
        bind:share="handleMomentShare"
      ></moment-list>
    </view>
  </view>

  <!-- 加载更多 -->
  <view class="load-more" wx:if="{{isLoading[currentTab] && dynamicList[currentTab].length > 0}}">
    <text>加载中...</text>
  </view>

  <!-- 空态提示 -->
  <view class="empty-state" wx:if="{{!isSkeletonLoading[currentTab] && dynamicList[currentTab].length === 0}}">
    <image src="../../assets/image/empty.png" mode="aspectFit" class="empty-icon"></image>
    <text class="empty-text">{{hasNetwork ? (currentTab === 'inCircle' ? '暂无CP好友动态~ 快去建立CP关系吧' : '暂无推荐动态~ 发布你的第一条动态吧') : '网络异常，请检查网络后重试'}}</text>
    <button class="refresh-btn" wx:if="!hasNetwork" bindtap="refreshList">重新加载</button>
    <button class="guide-btn" wx:if="{{hasNetwork && currentTab === 'inCircle'}}" bindtap="gotoBuildCP">建立CP关系</button>
    <button class="guide-btn" wx:if="{{hasNetwork && currentTab === 'outCircle'}}" bindtap="gotoPublish">发布动态</button>
  </view>
</scroll-view>